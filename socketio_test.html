<!DOCTYPE html>
<html>
<head>
    <title>SocketIO Test</title>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #2c3e50; color: white; padding: 20px; }
        .log { background: #34495e; padding: 10px; margin: 10px 0; border-radius: 5px; }
        button { padding: 10px 20px; margin: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🧪 SocketIO Connection Test</h1>
    
    <div>
        <button onclick="testConnection()">Test Connection</button>
        <button onclick="triggerTestEvents()">Trigger Test Ping Events</button>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>
    
    <div id="status">Connecting...</div>
    <div id="logs"></div>

    <script>
        const socket = io();
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');
        
        function addLog(message, color = '#4CAF50') {
            const log = document.createElement('div');
            log.className = 'log';
            log.style.borderLeft = `4px solid ${color}`;
            log.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(log);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        // Connection events
        socket.on('connect', function() {
            statusDiv.innerHTML = '✅ Connected to server';
            statusDiv.style.color = '#4CAF50';
            addLog('Connected to SocketIO server', '#4CAF50');
        });
        
        socket.on('disconnect', function() {
            statusDiv.innerHTML = '❌ Disconnected from server';
            statusDiv.style.color = '#e74c3c';
            addLog('Disconnected from server', '#e74c3c');
        });
        
        // Test events
        socket.on('connection_test', function(data) {
            addLog(`Connection test: ${data.message}`, '#f39c12');
        });
        
        // Listen for all ping events
        socket.on('ping_update_external_cloudflare', function(data) {
            addLog(`🟠 Cloudflare ping: ${data.data}`, '#ff6b35');
        });
        
        socket.on('ping_update_external_google', function(data) {
            addLog(`🔵 Google ping: ${data.data}`, '#4285f4');
        });
        
        socket.on('ping_update_external_quad9', function(data) {
            addLog(`🟣 Quad9 ping: ${data.data}`, '#9b59b6');
        });
        
        socket.on('debug_ping_event', function(data) {
            addLog(`🔍 Debug event: ${data.event_name} - ${data.data.data}`, '#95a5a6');
        });
        
        // Catch all events for debugging
        const originalEmit = socket.emit;
        const originalOn = socket.on;
        
        socket.on = function(event, callback) {
            return originalOn.call(this, event, function(data) {
                if (event.includes('ping') || event.includes('debug')) {
                    addLog(`📡 Received event: ${event}`, '#3498db');
                }
                return callback(data);
            });
        };
        
        function testConnection() {
            socket.emit('test', {message: 'Hello from test page'});
            addLog('Sent test message to server', '#e67e22');
        }
        
        function triggerTestEvents() {
            fetch('/test-socketio')
                .then(response => response.json())
                .then(data => {
                    addLog(`Triggered test events: ${data.events_sent.join(', ')}`, '#2ecc71');
                })
                .catch(error => {
                    addLog(`Error: ${error}`, '#e74c3c');
                });
        }
        
        function clearLogs() {
            logsDiv.innerHTML = '';
        }
    </script>
</body>
</html>