{% extends "base.html" %}

{% block title %}Network Speed Test{% endblock %}

{% block extra_head %}
<style>
    .gauge-container {
        width: 250px;
        height: 200px;
        margin: 1rem auto;
    }
    .speed-results {
        display: flex;
        justify-content: space-around;
        text-align: center;
        margin-top: 2rem;
    }
    #start-speed-test-btn {
        display: block;
        margin: 2rem auto;
        font-size: 1.5rem;
        padding: 1rem 2rem;
    }
    .progress-bar {
        width: 100%;
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        margin-top: 1rem;
    }
    .progress-bar-inner {
        width: 0%;
        height: 20px;
        background: linear-gradient(90deg, #4CAF50, #81C784);
        border-radius: 10px;
        transition: width 0.5s ease-in-out;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.3.1/raphael-2.1.4.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/justgage@1.3.1/justgage.min.js"></script>
{% endblock %}

{% block content %}
<div class="card">
    <h1>üöÄ Internet Speed Test</h1>
    <p>Measure your network's download speed, upload speed, and latency.</p>
    
    <div style="margin: 1rem 0;">
        <label for="provider-select" style="display: block; margin-bottom: 0.5rem;">Choose Speed Test Provider:</label>
        <select id="provider-select" style="width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #fff; background: rgba(0,0,0,0.2); color: #fff;">
            <option value="ookla">üöÄ Ookla Speedtest.net (Most Popular)</option>
            <option value="fast">üì∫ Fast.com (Netflix CDN)</option>
            <option value="libre">üîì LibreSpeed (Open Source)</option>
            <option value="simple">üîó Simple HTTP Test (Firewall-friendly)</option>
        </select>
    </div>
    
    <div style="margin: 1rem 0;">
        <label for="server-select" style="display: block; margin-bottom: 0.5rem;">Choose Test Server:</label>
        <select id="server-select" style="width: 100%; padding: 0.5rem; border-radius: 5px; border: 1px solid #fff; background: rgba(0,0,0,0.2); color: #fff;">
            <option value="">Auto (Best Server)</option>
        </select>
    </div>
    
    <button id="start-speed-test-btn" class="btn">Start Test</button>
</div>

<div class="card" id="logs-card" style="display: none;">
    <h2>üìù Speed Test Logs</h2>
    <div class="log-container" id="speed-test-logs" style="height: 300px; background: #1e1e1e; color: #fff; padding: 1rem; border-radius: 5px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.85rem;">
        <div class="log-line">Waiting for test to start...</div>
    </div>
</div>

<div class="card" id="results-card" style="display: none;">
    <h2>üìä Speed Test Results</h2>
    <div class="speed-results">
        <div>
            <div id="download-gauge" class="gauge-container"></div>
            <h3>Download</h3>
        </div>
        <div>
            <div id="upload-gauge" class="gauge-container"></div>
            <h3>Upload</h3>
        </div>
    </div>
    <div class="stats-grid" style="margin-top: 2rem;">
        <div class="stat-card">
            <div class="stat-value" id="ping-result">--</div>
            <div class="stat-label">Ping / Latency</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="server-info">--</div>
            <div class="stat-label">Test Server</div>
        </div>
    </div>
</div>

<div class="card" id="progress-card" style="display: none;">
    <h2>üîÑ Test in Progress...</h2>
    <p id="progress-status">Initializing...</p>
    <div class="progress-bar">
        <div class="progress-bar-inner" id="progress-bar-inner"></div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const startBtn = document.getElementById('start-speed-test-btn');
    const progressCard = document.getElementById('progress-card');
    const resultsCard = document.getElementById('results-card');
    const progressStatus = document.getElementById('progress-status');
    const progressBar = document.getElementById('progress-bar-inner');

    let downloadGauge, uploadGauge;
    let currentProvider = 'ookla';

    // Load available servers for selected provider
    function loadServers(provider) {
        const serverSelect = document.getElementById('server-select');
        serverSelect.innerHTML = '<option value="">Auto (Best Server)</option>';
        
        // Simple HTTP test doesn't need server selection
        if (provider === 'simple') {
            const option = document.createElement('option');
            option.value = 'http_endpoints';
            option.textContent = 'Multiple HTTP Endpoints (Google, Cloudflare, etc.)';
            serverSelect.appendChild(option);
            return;
        }
        
        fetch(`/api/speed-test-servers?provider=${provider}`)
            .then(response => response.json())
            .then(data => {
                if (data.servers) {
                    data.servers.forEach(server => {
                        const option = document.createElement('option');
                        option.value = server.id;
                        option.textContent = `${server.sponsor} - ${server.name} (${server.distance}km)`;
                        serverSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error loading servers:', error));
    }

    // Provider selection handler
    document.getElementById('provider-select').addEventListener('change', function() {
        currentProvider = this.value;
        loadServers(currentProvider);
    });

    // Load initial servers
    loadServers(currentProvider);

    function addLogEntry(message, type = 'info') {
        const logsContainer = document.getElementById('speed-test-logs');
        const logLine = document.createElement('div');
        logLine.className = 'log-line';
        
        const timestamp = new Date().toLocaleTimeString();
        const typeIcon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
        
        logLine.innerHTML = `[${timestamp}] ${typeIcon} ${message}`;
        logLine.style.color = type === 'success' ? '#00ff00' : type === 'error' ? '#ff4444' : type === 'warning' ? '#ffaa00' : '#ffffff';
        
        logsContainer.appendChild(logLine);
        logsContainer.scrollTop = logsContainer.scrollHeight;
    }

    startBtn.addEventListener('click', () => {
        startBtn.disabled = true;
        startBtn.textContent = 'Testing...';
        progressCard.style.display = 'block';
        resultsCard.style.display = 'none';
        
        // Show and clear logs
        const logsCard = document.getElementById('logs-card');
        logsCard.style.display = 'block';
        document.getElementById('speed-test-logs').innerHTML = '';
        
        const serverId = document.getElementById('server-select').value;
        const testData = { 
            provider: currentProvider,
            server_id: serverId || null
        };
        
        addLogEntry(`Starting speed test with ${currentProvider.toUpperCase()} provider`);
        if (serverId) {
            addLogEntry(`Using server: ${serverId}`);
        } else {
            addLogEntry('Auto-selecting best server');
        }
        
        socket.emit('run_speed_test', testData);
    });

    socket.on('speed_test_update', (data) => {
        const message = data.message || data.status;
        progressStatus.textContent = message;
        
        // Add to logs
        addLogEntry(message, data.status === 'error' ? 'error' : data.status === 'finished' ? 'success' : 'info');

        switch (data.status) {
            case 'starting':
                progressBar.style.width = '10%';
                break;
            case 'server':
                progressBar.style.width = '20%';
                break;
            case 'server_found':
                progressBar.style.width = '25%';
                const serverName = data.server ? `${data.server.sponsor || 'Unknown'} (${data.server.name || 'Unknown'})` : 'Server Selected';
                document.getElementById('server-info').textContent = serverName;
                addLogEntry(`Connected to server: ${serverName}`, 'success');
                break;
            case 'downloading':
                progressBar.style.width = '40%';
                addLogEntry('Testing download speed...', 'info');
                break;
            case 'download_complete':
                progressBar.style.width = '65%';
                const downloadSpeed = parseFloat(data.download_speed) || 0;
                addLogEntry(`Download speed: ${downloadSpeed.toFixed(2)} Mbps`, 'success');
                
                if (!downloadGauge) {
                    downloadGauge = new JustGage({
                        id: 'download-gauge',
                        value: downloadSpeed,
                        min: 0,
                        max: Math.max(300, Math.ceil(downloadSpeed / 50) * 50 + 50),
                        title: `${downloadSpeed.toFixed(2)} Mbps`,
                        levelColors: ['#f44336', '#ff9800', '#4CAF50'],
                        humanFriendly: true,
                        humanFriendlyDecimal: 2
                    });
                } else {
                    downloadGauge.refresh(downloadSpeed, Math.max(300, Math.ceil(downloadSpeed / 50) * 50 + 50));
                }
                break;
            case 'uploading':
                progressBar.style.width = '80%';
                addLogEntry('Testing upload speed...', 'info');
                break;
            case 'upload_complete':
                progressBar.style.width = '100%';
                const uploadSpeed = parseFloat(data.upload_speed) || 0;
                addLogEntry(`Upload speed: ${uploadSpeed.toFixed(2)} Mbps`, 'success');
                
                if (!uploadGauge) {
                    uploadGauge = new JustGage({
                        id: 'upload-gauge',
                        value: uploadSpeed,
                        min: 0,
                        max: Math.max(250, Math.ceil(uploadSpeed / 50) * 50 + 50),
                        title: `${uploadSpeed.toFixed(2)} Mbps`,
                        levelColors: ['#f44336', '#ff9800', '#4CAF50'],
                        humanFriendly: true,
                        humanFriendlyDecimal: 2
                    });
                } else {
                    uploadGauge.refresh(uploadSpeed, Math.max(250, Math.ceil(uploadSpeed / 50) * 50 + 50));
                }
                break;
            case 'finished':
                progressCard.style.display = 'none';
                resultsCard.style.display = 'block';
                
                // Display results
                const results = data.results || {};
                const ping = results.ping || 0;
                document.getElementById('ping-result').textContent = `${ping.toFixed(2)} ms`;
                
                addLogEntry(`Speed test completed successfully!`, 'success');
                addLogEntry(`Final Results - Download: ${results.download_mbps?.toFixed(2) || 0} Mbps, Upload: ${results.upload_mbps?.toFixed(2) || 0} Mbps, Ping: ${ping.toFixed(2)} ms`, 'success');
                
                startBtn.disabled = false;
                startBtn.textContent = 'Run Test Again';
                break;
            case 'error':
                addLogEntry(`Error: ${data.message}`, 'error');
                progressStatus.textContent = `Error: ${data.message}`;
                startBtn.disabled = false;
                startBtn.textContent = 'Try Again';
                break;
        }
    });
</script>
{% endblock %}
